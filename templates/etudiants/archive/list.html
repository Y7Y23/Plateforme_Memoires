{% extends "base_etudiant.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-0">Archive des mémoires & rapports</h3>
    <div class="text-muted">Consulte les documents validés selon l’année, le département et le type.</div>
  </div>
</div>

<form method="get" class="card mb-3">
  <div class="card-body">
    <div class="row g-2">
      <div class="col-md-4">
        <input class="form-control" name="q" value="{{ q }}" placeholder="Rechercher (titre, étudiant, description...)">
      </div>

      <div class="col-md-2">
        <select class="form-select" name="type">
          <option value="">— Type —</option>
          {% for t in types %}
            <option value="{{ t }}" {% if type == t %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <select class="form-select" name="annee_id">
          <option value="">— Année —</option>
          {% for a in annees %}
            <option value="{{ a.id_annee }}" {% if annee_id|stringformat:"s" == a.id_annee|stringformat:"s" %}selected{% endif %}>
              {{ a.libelle }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <select class="form-select" name="dep_id">
          <option value="">— Département —</option>
          {% for d in departements %}
            <option value="{{ d.id_departement }}" {% if dep_id|stringformat:"s" == d.id_departement|stringformat:"s" %}selected{% endif %}>
              {{ d.nom_departement }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 mt-2 d-flex align-items-center gap-2">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="1" id="only_effectuee" name="only_effectuee"
                 {% if only_effectuee == "1" %}checked{% endif %}>
          <label class="form-check-label" for="only_effectuee">
            Uniquement ceux avec soutenance effectuée
          </label>
        </div>

        <button class="btn btn-primary ms-auto">Filtrer</button>
        <a class="btn btn-outline-secondary" href="{% url 'etudiant:archive_list' %}">Réinitialiser</a>
      </div>
    </div>
  </div>
</form>

<div class="card">
  <div class="card-body">
    {% if rows %}
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Titre</th>
              <th>Type</th>
              <th>Année</th>
              <th>Département</th>
              <th>Étudiant</th>
              <th>Soutenance</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ r.titre }}</div>
                  <div class="text-muted small">Déposé : {{ r.date_depot|date:"Y-m-d H:i" }}</div>
                </td>
                <td><span class="badge bg-info text-dark">{{ r.type }}</span></td>
                <td>{{ r.annee_libelle }}</td>
                <td>{{ r.nom_departement }}</td>
                <td>{{ r.etu_nom }} {{ r.etu_prenom }}</td>
                <td>
                  {% if r.id_soutenance %}
                    <span class="badge {% if r.soutenance_statut == 'EFFECTUEE' %}bg-success{% elif r.soutenance_statut == 'PLANIFIEE' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                      {{ r.soutenance_statut }}
                    </span>
                    <div class="text-muted small">
                      {{ r.soutenance_date }} {{ r.soutenance_heure }}
                    </div>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'etudiant:archive_detail' r.id_memoire %}">
                    Détails
                  </a>
                  {% if r.pdf_url %}
                    <a class="btn btn-sm btn-primary" href="{{ r.pdf_url }}" target="_blank" rel="noopener">
                      PDF
                    </a>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-muted">Aucun document trouvé dans l’archive avec ces filtres.</div>
    {% endif %}
  </div>
</div>

{% endblock %}
