{% extends "base_admin.html" %}
{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
  .stat-card {
    border-radius: 15px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    overflow: hidden;
  }
  
  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
  }
  
  .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
  }
  
  .stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 10px 0 5px 0;
    line-height: 1;
  }
  
  .stat-label {
    font-size: 0.9rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .chart-card {
    border-radius: 15px;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  }
  
  .chart-container {
    position: relative;
    height: 300px;
  }
  
  .gradient-blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  .gradient-green { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
  .gradient-orange { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
  .gradient-purple { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
  .gradient-red { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
  .gradient-teal { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
  
  .trend-indicator {
    font-size: 0.85rem;
    padding: 4px 10px;
    border-radius: 20px;
    display: inline-block;
    margin-top: 8px;
  }
  
  .trend-up { background: #d4edda; color: #155724; }
  .trend-down { background: #f8d7da; color: #721c24; }
  
  .mini-stat {
    padding: 15px;
    border-radius: 10px;
    background: #f8f9fa;
    margin-bottom: 10px;
  }
  
  .mini-stat-label {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 5px;
  }
  
  .mini-stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2c3e50;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <h3 class="fw-bold mb-3">Dashboard</h3>
  <ul class="breadcrumbs mb-3">
    <li class="nav-home">
      <a href="/Administration/"><i class="icon-home"></i></a>
    </li>
    <li class="separator"><i class="icon-arrow-right"></i></li>
  </ul>
</div>

<!-- Statistiques principales -->
<div class="row mb-4">
  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="stat-icon gradient-blue text-white me-3">
          <i class="fas fa-user-graduate"></i>
        </div>
        <div class="flex-grow-1">
          <div class="stat-label">Étudiants</div>
          <div class="stat-number">{{ nb_etudiants }}</div>
          <div class="trend-indicator trend-up">
            <i class="fas fa-arrow-up"></i> Actifs
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="stat-icon gradient-green text-white me-3">
          <i class="fas fa-chalkboard-teacher"></i>
        </div>
        <div class="flex-grow-1">
          <div class="stat-label">Responsables</div>
          <div class="stat-number">{{ nb_responsables }}</div>
          <div class="trend-indicator trend-up">
            <i class="fas fa-check-circle"></i> Total
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="stat-icon gradient-orange text-white me-3">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="flex-grow-1">
          <div class="stat-label">Mémoires</div>
          <div class="stat-number">{{ total_memoires }}</div>
          <div class="trend-indicator trend-up">
            <i class="fas fa-chart-line"></i> Total
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6 mb-3">
    <div class="card stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="stat-icon gradient-purple text-white me-3">
          <i class="fas fa-calendar-check"></i>
        </div>
        <div class="flex-grow-1">
          <div class="stat-label">Soutenances</div>
          <div class="stat-number">{{ total_soutenances }}</div>
          <div class="trend-indicator trend-up">
            <i class="fas fa-calendar-alt"></i> Année
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Graphiques principaux -->
<div class="row mb-4">
  <div class="col-md-6 mb-4">
    <div class="card chart-card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-chart-pie me-2"></i>Mémoires par Statut
        </h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="statutChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6 mb-4">
    <div class="card chart-card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-chart-line me-2"></i>Soutenances par Mois
        </h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="soutenancesChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Statistiques secondaires -->
<div class="row mb-4">
  <div class="col-md-8 mb-4">
    <div class="card chart-card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-building me-2"></i>Étudiants par Département
        </h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="departementChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-4 mb-4">
    <div class="card chart-card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-info-circle me-2"></i>Statistiques Rapides
        </h5>
      </div>
      <div class="card-body">
        <div class="mini-stat">
          <div class="mini-stat-label">
            <i class="fas fa-users me-1"></i>Jurys Actifs
          </div>
          <div class="mini-stat-value">{{ nb_jurys }}</div>
        </div>
        
        <div class="mini-stat">
          <div class="mini-stat-label">
            <i class="fas fa-door-open me-1"></i>Salles Disponibles
          </div>
          <div class="mini-stat-value">{{ nb_salles }}</div>
        </div>
        
        <div class="mini-stat">
          <div class="mini-stat-label">
            <i class="fas fa-building me-1"></i>Départements
          </div>
          <div class="mini-stat-value">{{ nb_departements }}</div>
        </div>
        
        <div class="mini-stat">
          <div class="mini-stat-label">
            <i class="fas fa-check-circle me-1"></i>Mémoires Validés
          </div>
          <div class="mini-stat-value">{{ memoires_valides }}</div>
        </div>
        
        <div class="mini-stat">
          <div class="mini-stat-label">
            <i class="fas fa-clock me-1"></i>En Vérification
          </div>
          <div class="mini-stat-value">{{ memoires_en_verification }}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Graphiques types de mémoires et notes -->
<div class="row mb-4">
  <div class="col-md-6 mb-4">
    <div class="card chart-card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-layer-group me-2"></i>Types de Mémoires
        </h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="typesChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6 mb-4">
    <div class="card chart-card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-chart-bar me-2"></i>Distribution des Notes
        </h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="notesChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Activité récente -->
<div class="row">
  <div class="col-12">
    <div class="card chart-card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="fas fa-history me-2"></i>Activité des 7 Derniers Jours
        </h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="activityChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  Chart.defaults.font.family = "'Inter', sans-serif";
  Chart.defaults.color = '#6c757d';

  const colors = {
    gradient: [
      'rgba(102, 126, 234, 0.8)',
      'rgba(118, 75, 162, 0.8)',
      'rgba(240, 147, 251, 0.8)',
      'rgba(79, 172, 254, 0.8)',
      'rgba(67, 233, 123, 0.8)'
    ],
    border: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b']
  };

  // Parser les données JSON depuis Django
  const memStats = JSON.parse('{{ mem_stats_json|safe }}');
  const soutenancesMois = JSON.parse('{{ soutenances_par_mois_json|safe }}');
  const etudiantsDept = JSON.parse('{{ etudiants_par_dept_json|safe }}');
  const memoiresType = JSON.parse('{{ memoires_par_type_json|safe }}');
  const notesDistrib = JSON.parse('{{ notes_distribution_json|safe }}');
  const activite = JSON.parse('{{ activite_7_jours_json|safe }}');

  // 1. Graphique des statuts
  const statutCanvas = document.getElementById('statutChart');
  if (statutCanvas && memStats.length > 0) {
    new Chart(statutCanvas.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: memStats.map(d => d.label),
        datasets: [{
          data: memStats.map(d => d.value),
          backgroundColor: colors.gradient,
          borderColor: colors.border,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { padding: 15, font: { size: 12 } }
          },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)',
            padding: 12
          }
        }
      }
    });
  }

  // 2. Soutenances par mois
  const soutenancesCanvas = document.getElementById('soutenancesChart');
  if (soutenancesCanvas && soutenancesMois.length > 0) {
    new Chart(soutenancesCanvas.getContext('2d'), {
      type: 'line',
      data: {
        labels: soutenancesMois.map(d => d.label),
        datasets: [{
          label: 'Soutenances',
          data: soutenancesMois.map(d => d.value),
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: '#667eea',
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', padding: 12 }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { precision: 0 },
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          x: { grid: { display: false } }
        }
      }
    });
  }

  // 3. Par département
  const departementCanvas = document.getElementById('departementChart');
  if (departementCanvas && etudiantsDept.length > 0) {
    new Chart(departementCanvas.getContext('2d'), {
      type: 'bar',
      data: {
        labels: etudiantsDept.map(d => d.label),
        datasets: [{
          label: 'Étudiants',
          data: etudiantsDept.map(d => d.value),
          backgroundColor: 'rgba(102, 126, 234, 0.8)',
          borderColor: '#667eea',
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', padding: 12 }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { precision: 0 },
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          x: { grid: { display: false } }
        }
      }
    });
  }

  // 4. Types de mémoires
  const typesCanvas = document.getElementById('typesChart');
  if (typesCanvas && memoiresType.length > 0) {
    new Chart(typesCanvas.getContext('2d'), {
      type: 'pie',
      data: {
        labels: memoiresType.map(d => d.label),
        datasets: [{
          data: memoiresType.map(d => d.value),
          backgroundColor: colors.gradient,
          borderColor: '#fff',
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { padding: 15, font: { size: 12 } }
          }
        }
      }
    });
  }

  // 5. Distribution des notes
  const notesCanvas = document.getElementById('notesChart');
  if (notesCanvas && notesDistrib.length > 0) {
    new Chart(notesCanvas.getContext('2d'), {
      type: 'bar',
      data: {
        labels: notesDistrib.map(d => d.label),
        datasets: [{
          label: 'Nombre',
          data: notesDistrib.map(d => d.value),
          backgroundColor: [
            'rgba(220, 53, 69, 0.8)',
            'rgba(255, 193, 7, 0.8)',
            'rgba(0, 123, 255, 0.8)',
            'rgba(40, 167, 69, 0.8)',
            'rgba(102, 126, 234, 0.8)'
          ],
          borderWidth: 0,
          borderRadius: 8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { beginAtZero: true, ticks: { precision: 0 } }
        }
      }
    });
  }

  // 6. Activité 7 jours
  const activityCanvas = document.getElementById('activityChart');
  if (activityCanvas && activite.length > 0) {
    const ctx = activityCanvas.getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(102, 126, 234, 0.4)');
    gradient.addColorStop(1, 'rgba(102, 126, 234, 0.0)');
    
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: activite.map(d => d.label),
        datasets: [{
          label: 'Dépôts de mémoires',
          data: activite.map(d => d.value),
          borderColor: '#667eea',
          backgroundColor: gradient,
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 6,
          pointHoverRadius: 8,
          pointBackgroundColor: '#667eea',
          pointBorderColor: '#fff',
          pointBorderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top' }
        },
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 } }
        }
      }
    });
  }
});
</script>
{% endblock %}